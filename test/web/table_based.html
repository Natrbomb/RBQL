<!DOCTYPE html>
<html>
<head>


<script src="../../rbql-js/web_rbql.js"></script>

<script>

    function read_html_table_without_header(table_element) {
        let result = [];
        let num_rows = table_element.rows.length;
        for (let r = 1; r < num_rows; r++) {
            // XXX this is just a demo code, it is not very reliable because some tables may not have a header row.
            let cells = table_element.rows.item(r).cells;
            let out_record = [];
            for (let c = 0; c < cells.length; c++) {
                out_record.push(cells.item(c).innerHTML)
            }
            result.push(out_record);
        }
        return result;
    }


    function clear_html_table(table_element) {
        let num_rows = table_element.rows.length;
        for (let i = 0; i < num_rows; i++) {
            table_element.deleteRow(0);
        }
    }


    function write_html_table(src_array, dst_table_element) {
        clear_html_table(dst_table_element);
        for (let r = 0; r < src_array.length; r++) {
            let row = dst_table_element.insertRow(r);
            for (let c = 0; c < src_array[r].length; c++) {
                let cell = row.insertCell(c);
                cell.innerHTML = String(src_array[r][c]);
            }
        }
    }

    function process_query() {
        let input_table = read_html_table_without_header(document.getElementById('src_table'));
        let output_table = [];
        let user_query = document.getElementById('query_input').value;
        clear_html_table(document.getElementById('dst_table'));
        let error_handler = function(error_type, error_msg) {
            // FIXME show as message
            console.log('Error: ' + error_type + ': ' + error_msg);
        }
        let success_handler = function(warnings) {
            // FIXME show as message
            console.log('warnings: ' + JSON.stringify(warnings));
            console.log('output table: ' + JSON.stringify(output_table));
            write_html_table(output_table, document.getElementById('dst_table'));
        }
        rbql.table_run(user_query, input_table, output_table, success_handler, error_handler);
    }

    
    document.addEventListener("DOMContentLoaded", function(event) {
        document.getElementById("run_button").addEventListener("click", process_query);
    });

</script>


<title>RBQL Generic Test</title>
<style>
    table {
        border-collapse: collapse;
    }
    table, th, td {
        border: 1px solid black;
    }
</style>

</head>

<body>
<div>
<table id="src_table">
  <tr><th>a1: Name</th><th>a2: Age</th></tr>
  <tr><td>Adam</td><td>30</td></tr>
  <tr><td>Eve</td><td>29</td></tr>
  <tr><td>Alexander The Great</td><td>25</td></tr>
  <tr><td>Marilyn Monroe</td><td>35</td></tr>
</table>
<br><input id="query_input" type="text" style="width:500px" placeholder="select ... where ... order by ... limit ... "><button id="run_button">Run</button>
<br><br><table id="dst_table"></table>
</div>

</body>
</html>
